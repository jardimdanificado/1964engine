
// ⠄⠄⠄⠄⠄⠄⠄⠄⣠⣴⠶⠿⠛⠛⠛⠛⠛⠛⠷⠶⢶⣤⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
// ⠄⠄⠄⠄⠄⣤⣶⠟⠉⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠛⢿⣶⣤⠄⠄⠄⠄⠄⠄⠄⠄
// ⠄⠄⠄⣠⣾⠟⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠻⣿⣿⣦⡀⠄⠄⠄⠄⠄
// ⠄⠄⣼⣿⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠹⣿⣿⣿⣆⠄⠄⠄⠄
// ⠄⣸⣿⡇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⣿⣿⣿⣧⡀⠄⠄
// ⢰⣿⣿⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢰⣿⣿⣿⣿⣇⠄⠄
// ⢸⣿⣿⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⡀⠄
// ⢸⣿⣿⢠⣤⣤⣄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣀⣀⣠⣤⡀⠄⢸⣿⣿⡟⣿⣿⡇⠄
// ⢸⣿⣿⣿⠏⠛⠛⠿⣷⣶⣄⠄⠄⠄⠄⣠⣴⣾⣿⡿⠟⠛⠛⠛⠛⢦⣼⣿⣿⡔⣾⣿⡇⠄
// ⠄⢿⣿⡟⢀⣤⣶⣶⠾⢿⣿⣷⠄⠄⢠⣿⣿⢛⡿⢿⣷⡶⠦⣤⣄⡈⢿⣿⣿⣿⣾⣿⠃⠄
// ⣶⢾⣿⠄⠉⠁⠉⠉⠄⠤⠞⣿⠄⠄⢸⣿⡿⠄⠈⠄⠄⠁⠉⣽⠟⠄⠈⣿⣿⣿⣿⣿⣿⡇
// ⣿⣿⣿⠄⠄⠄⠄⠄⠄⠄⠄⠃⠄⠄⢸⣿⡇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣇⡏⣧
// ⣿⣿⣿⡇⠄⠄⠄⠄⠄⡴⠄⠣⡀⢀⣸⣿⠿⣷⠄⠄⠄⠄⠄⠄⠄⠄⣠⣿⣿⣿⣿⣿⣿⢸
// ⢹⣿⣿⣧⠄⠄⠄⠄⠄⠙⠚⣛⡊⣻⣿⡛⠗⠋⠄⠄⠄⠄⠄⠄⠄⢰⣿⣿⣿⣿⣿⣿⠏⡜
// ⠈⢻⣿⣿⡆⠄⠄⢀⣴⣴⣿⣿⠿⢾⡻⠿⢿⣶⣶⣦⡀⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⡜⠁
// ⠄⠄⣿⣿⣿⠄⠄⣾⣿⣿⠿⠛⠛⠛⠛⠿⠶⣿⣿⣿⣿⡆⠄⠄⢀⣿⣿⣿⣿⣿⡿⠟⠄⠄
// ⠄⠄⠄⢹⣿⣄⠄⠉⠁⠄⠳⢶⣶⣶⣶⣶⣾⣿⡟⠃⠄⠁⠄⠄⣼⣿⣿⣿⣿⣏⠄⠄⠄⠄
// ⠄⠄⠄⠘⣿⣿⣆⣀⣀⡀⡀⡖⣸⣶⣶⣿⣿⣿⣷⣦⡀⠄⢀⣾⣿⣿⣿⣿⣿⣿⠄⠄⠄⠄
// ⠄⠄⠄⠄⣿⣿⣿⣿⣿⠟⠁⠁⢿⣿⡿⠍⠻⣿⣿⣿⣿⣾⣿⣿⣿⣿⣿⣿⣿⣿⠄⠄⠄⠄
// ⠄⠄⠄⣼⣿⣿⡿⣿⣿⣴⠄⠰⣿⣿⣇⢀⠄⠸⣿⣿⣿⣿⣿⣿⠟⣿⣿⣿⣿⣿⡀⠄⠄⠄
// ⠄⠄⠘⠿⣿⣿⣿⣀⠙⠿⣷⣤⣼⣿⣿⣾⣷⣾⣿⡿⠟⠋⠉⠄⠄⣿⣿⣿⣿⣿⠇⠄⠄⠄
// ⠄⠄⠄⠄⠈⠛⠿⣿⣶⣤⡈⠛⢿⣿⣿⠿⠛⠉⠁⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⠄⠄⠄⠄
// ⠄⠄⠄⠄⠄⠄⠄⠈⠛⠿⣿⣿⣦⣤⣀⡀⠄⠄⠄⠄⠄⠄⠄⠄⢘⣿⣿⣿⣿⡿⠄⠄⠄⠄
// ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠉⠉⠛⠻⠿⠿⢶⣦⣄⣀⣀⣀⣀⣼⡿⠿⠿⠛⠁⠄⠄⠄⠄

#include "raylib/raylib.h"
#include <time.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>

#if defined(PLATFORM_DESKTOP)
    #define GLSL_VERSION            330
#else   // PLATFORM_RPI, PLATFORM_ANDROID, PLATFORM_WEB
    #define GLSL_VERSION            100
#endif

#define COR_SELECIONADO CLITERAL(Color){230,41,55,255} 

#define COR_NAOSELECIONADO CLITERAL(Color){0,0,0,255} 



char *msg;

#include "prestruct.h"
#include "camera/camera.c"
#include "etc/et.c"
#include "2d/font.c"
#include "item/item.h"
#include "personagem/personagem.h"
#include "ai/ai.h"
#include "map/map.c"
#include "etc/ambiente.h"
#include "render/load.c"
#include "render/render.c"
#include "savegame/savegame.h"
#include "menu/menu.c"
#include "input/teclado.c"




int main ( void )
{
    
	const int screenW = 600;
	const int screenH = 240;
	//SetConfigFlags(FLAG_MSAA_4X_HINT);
	RENDER_START_WINDOW(screenW,screenH);
    
	clock_t *relogio;
	relogio = malloc ( sizeof ( clock_t ) *10 );

	Camera camera = { 0 };
	camera = CAMERA_START(&camera);
    
    MENU menu;
    menu.estaAberto = true;

	AMBIENTE ambiente;
	ambiente.gravidade = 0.2;

	PERSONAGEM personagem;
	ITEM item;
    MAPA mapa;
    //NPC0 *humano;
    //humano = malloc(sizeof(NPC0)*10);
    NPC0 humano;
	LOADALL_MODELS(&mapa,&personagem,&item);
	PERSONAGEM_CONFIGSTART ( &personagem );
    MAPA_START(personagem,&mapa,&humano);
    
    
	personagem.equip.calca.modelo = item.calca[1].idle;
    personagem.equip.chapeu.modelo = item.chapeu[1].idle;
    personagem.equip.camisa.modelo = item.camisa[1].idle;
    personagem.equip.arma.modelo = item.arma[1].idle;
	msg = malloc ( sizeof ( char ) *255 );
	msg = " ";
	Font font = FONT_START(screenH);
	Vector2 fontPosition = { 0, 0 };
    
    MENU_START( mapa, &camera, font, fontPosition, &menu);
    
	SetTargetFPS ( 60 );
    camera.target =  (Vector3){personagem.posicao.x,personagem.posicao.y+2,personagem.posicao.z};
    SetExitKey(KEY_END);
	while ( !WindowShouldClose()&&menu.sair == false )      // Detect window close button or ESC key
	{
        //if(IsKeyPressed(KEY_B))
        AIHUMAN_DEFINEALVO(&humano, 0, personagem.posicao);
        
        AIHUMAN_MOVIMENTO(personagem, mapa, &humano, 0, item);
        
		UpdateCamera ( &camera );
		GRAVIDADE ( &personagem, &ambiente, mapa );
        GRAVIDADE_AIHUMAN(&humano.npc[0], &ambiente, mapa);
        
        for(int i =0; i<255; i++)
        {
            if ( mapa.balas[i].existe == true&& mapa.balas[i].parou == false)
            {
                GRAVIDADE_BALA( &mapa.balas[i].posicao, ambiente);
            }
        }
//         for(int i =0; i<10; i++)
//         {
//             if ( humano.npc[i].usando != false )
//             {
//                 AIHUMAN_USEANIM ( &humano.npc[i] , &mapa, item);
//             }
//         }
        if ( humano.npc[0].usando != false )
        {
            AIHUMAN_USEANIM ( &humano.npc[0] , &mapa, item, personagem);
        }
        else if(humano.npc[0].usando == false&&humano.npc[0].andando == false)
        {
            humano.npc[0].modelo.atual = personagem.modelo.idle;
        }
        
		if ( personagem.usando != false )
		{
			PERSONAGEM_USEANIM ( &personagem , &mapa, item);
		}
		else if ( menu.esc == true )
		{
			MENU_ESC(font, &menu, false,&personagem,&mapa,&humano);
		}
		else
		{
			TECLADO_MAIN ( &personagem, &item, &mapa, &humano, &menu, font);
		}

		if ( personagem.rotacao == 360 )
			personagem.rotacao=0;

		PERSONAGEM_HITBOXUPDATE ( &personagem );
		
		//----------------------------------------------------------------------------------
		// Draw
		//----------------------------------------------------------------------------------
        for(int i = 0; i< 10; i++)
        {
            if(mapa.porta.slots[i].abrindo||mapa.porta.slots[i].fechando)
            {
                if(mapa.porta.slots[i].existe == true)
                    PORTA_ANIM(&mapa); 
            }
        }
        MAPA_BALAUPDATE(&mapa,  1);
        if(clock() > personagem.relogioLogs+(2*(CLOCKS_PER_SEC/10)))
        {
            msg = " ";
        }
        RENDER_CAMERAUPDATE(personagem, mapa, &camera);
//         int testeExiste[2];
//         if(mapa.balas[0].existe)
//             testeExiste[0] = 1;
//         else
//             testeExiste[0] = 0;
//         
//         if(mapa.balas[0].parou)
//             testeExiste[1] = 1;
//         else
//             testeExiste[1] = 0;
//         
//         char texto_teste[100];
//         snprintf(texto_teste, 100, "x:%f y:%f z:%f\nexiste?%d parou?%d\nvelcidade:%f rotacao:%d", mapa.balas[0].posicao.x , mapa.balas[0].posicao.y, mapa.balas[0].posicao.z,testeExiste[0],testeExiste[1],mapa.balas[0].velocidade, mapa.balas[0].rotacao);
//         msg = texto_teste;
        
        
//         mapa->item[0].ponteiro;
        
		RENDER(personagem,humano, mapa, camera, font, fontPosition, menu);

        
	}

	UNLOADALL_MODELS(&personagem, &item, &mapa);
    //free(humano);
	free ( relogio );
	free ( msg );
    for(int i= 0; i<10;i++)
    {
        free(mapa.item[i].nome);
    }
	CloseWindow();              // Close window and OpenGL context
	//--------------------------------------------------------------------------------------

	return 0;
}
